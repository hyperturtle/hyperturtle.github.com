((function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;n=_.template("<div  class=\"tile tile_<%=data.x%>_<%=data.y%> tiletype_<%=data.type%>\"  data-robot='<%=JSON.stringify(data)%>'></div>"),m=10,d={drill:0,laser:1,grass:2,plant:3,tree:4,forest:5,cloud:6},o={none:0,ice:1,water:2,trash:3,grass:100,plant:101,tree:102,forest:103},p=_(o).chain().values().map(function(a){return"tiletype_"+a}).value().join(" "),e=_(d).chain().values().map(function(a){return"cursor_"+a}).value().join(" "),a=0,k=[],c=[],l=function(){return _(_.range(m)).map(function(a){return _(_.range(m)).map(function(b){return{type:Math.floor(Math.random()*4),x:a,y:b}})})},f=function(){var a,b,c,d;d=[];for(a=0,c=m-1;0<=c?a<=c:a>=c;0<=c?a++:a--)d.push(function(){var c,d;d=[];for(b=0,c=m-1;0<=c?b<=c:b>=c;0<=c?b++:b--)d.push(k[0][a][b].tile=$(n({data:{x:a,y:b,type:k[0][a][b].type}})).appendTo("#map"));return d}());return d},g=function(){return a=Math.floor(Math.random()*3),$("#cursor").removeClass(e).addClass("cursor_"+a)},j=function(a,b,c){return _([[a+1,b],[a-1,b],[a,b+1],[a,b-1]]).chain().filter(function(a){return a[0]>=0&&a[0]<m}).filter(function(a){return a[1]>=0&&a[1]<m}).filter(function(a){return c(k[0][a[0]][a[1]].type)}).value()},h=function(a,b,c){var d,e,f,g,h;f=_.union([[a,b]],j(a,b,c)),d=0;while(d!==f.length){d=f.length;for(g=0,h=f.length;g<h;g++)e=f[g],f=_.union(f,j(e[0],e[1],c)),f=_.unique(f,!1,function(a){return a[0]+","+a[1]})}return f},q=function(a){return a.tile.removeClass(p).addClass("tiletype_"+a.type)},b=function(a){var b,c,d,e,f;switch(a.type){case o.grass:case o.plant:case o.tree:case o.forest:b=h(a.x,a.y,function(b){return b===a.type||b===o.water});break;default:return}switch(a.type){case o.grass:case o.plant:case o.tree:case o.forest:case o.water:if(b.length>=3){d=a.type;for(e=0,f=b.length;e<f;e++)c=b[e],k[0][c[0]][c[1]].type=o.none,q(k[0][c[0]][c[1]]);d=Math.min(o.tree,d+Math.floor(b.length/3)-1),console.log(d);switch(d){case o.tree:a.type=o.forest;break;case o.plant:a.type=o.tree;break;case o.grass:a.type=o.plant}return q(a),!0}}return!1},i=function(){var a,b,c,d,e;a={};for(b=0,d=m-1;0<=d?b<=d:b>=d;0<=d?b++:b--)for(c=0,e=m-1;0<=e?c<=e:c>=e;0<=e?c++:c--)a[k[0][b][c].type]=a[k[0][b][c].type]||0,a[k[0][b][c].type]+=1;return a},$(function(){return k.push(l()),g(),f(),$(".tile").live("click",function(){var c,e,f;e=$(this).data("robot"),f=k[0][e.x][e.y],c=!0;switch(a){case d.grass:switch(f.type){case o.none:f.type=o.grass;break;default:c=!1}break;case d.drill:switch(f.type){case o.trash:f.type=o.none;break;case o.grass:case o.plant:case o.tree:case o.none:f.type=o.none;break;default:c=!1}break;case d.laser:switch(f.type){case o.ice:f.type=o.water;break;case o.water:case o.none:f.type=o.none}break;default:c=!1}if(c){q(f);for(;;)if(!b(f))break;g()}return console.log(i())})})})).call(this);