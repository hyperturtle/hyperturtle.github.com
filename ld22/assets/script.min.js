((function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B;v=_.template("<div  class=\"tile tile_<%=data.x%>_<%=data.y%> tiletype_<%=data.type%>\"  data-robot='<%=JSON.stringify(data)%>'></div>"),e=_.template('<div  class="cloud cloudid_<%=data.id%> cloudtype_<%=data.type%>"  style="top:<%=data.x*50%>px; left:<%=data.y*50%>px"  data-robot=\'<%=JSON.stringify(data)%>\'></div>'),r=_.template('<b>Storage</b><br/><a href="" class="res" data-robot="2">grass:</a> infin<br/><a href="" class="res" data-robot="0">drill:</a> infin<br/><a href="" class="res" data-robot="1">laser:</a>  <%=laser%><br/><a href="" class="res" data-robot="3">plant:</a>  <%=plant%>  <br/><a href="" class="res" data-robot="4">tree:</a>   <%=tree%>   <br/><a href="" class="res" data-robot="5">forest:</a> <%=forest%> <br/><a href="" class="res" data-robot="6">cloud:</a>  <%=cloud%>  <br/>'),t=_.template("<b>Progres</b><br/>Water: <%=water%> <br/>Plants:  <%=plant%>  <br/>"),q=10,h={drill:0,laser:1,grass:2,plant:3,tree:4,forest:5,cloud:6},w={none:0,ice:1,water:2,trash:3,acid:4,grass:100,plant:101,tree:102,forest:103},g={none:-1,acid:0,water:1},s={laser:0,plant:0,tree:0,forest:0,cloud:0},x=_(w).chain().values().map(function(a){return"tiletype_"+a}).value().join(" "),i=_(h).chain().values().map(function(a){return"cursor_"+a}).value().join(" "),b=0,o=[],f=[],y=0,p=function(b){var c,d;b==null&&(b=0),o=[],f=[],o.push(_(_.range(q)).map(function(a){return _(_.range(q)).map(function(c){var d;d=w.none;switch(b){case 0:d=Math.floor(Math.random()*4);break;case 1:d=Math.floor(Math.random()*5);break;case 2:d=Math.floor(Math.random()*5),d===w.water&&(d=w.trash);break;case 3:d=Math.floor(Math.random()*5),d===w.water&&(d=w.trash),d===w.water&&(d=w.trash)}return{type:d,x:a,y:c}})})),c=0;switch(b){case 1:c=10;break;case 2:c=20;break;case 3:c=40}d=[];while(f.length<c)d.push(a(Math.floor(Math.random()*q),Math.floor(Math.random()*q),g.acid));return d},j=function(){var a,b,c,d;d=[];for(a=0,c=q-1;0<=c?a<=c:a>=c;0<=c?a++:a--)d.push(function(){var c,d;d=[];for(b=0,c=q-1;0<=c?b<=c:b>=c;0<=c?b++:b--)d.push(o[0][a][b].tile=$(v({data:{x:a,y:b,type:o[0][a][b].type}})).appendTo("#map"));return d}());return d},u=function(a){return b=a,$("#cursor").removeClass(i).addClass("cursor_"+b),$("#info").removeClass().addClass("ct_"+b)},k=function(){return b=2,$("#cursor").removeClass(i).addClass("cursor_"+b),$("#info").removeClass().addClass("ct_"+b)},n=function(a,b,c){return _([[a+1,b],[a-1,b],[a,b+1],[a,b-1]]).chain().filter(function(a){return a[0]>=0&&a[0]<q}).filter(function(a){return a[1]>=0&&a[1]<q}).filter(function(a){return c(o[0][a[0]][a[1]].type)}).value()},l=function(a,b,c){var d,e,f,g,h;f=_.union([[a,b]],n(a,b,c)),d=0;while(d!==f.length){d=f.length;for(g=0,h=f.length;g<h;g++)e=f[g],f=_.union(f,n(e[0],e[1],c)),f=_.unique(f,!1,function(a){return a[0]+","+a[1]})}return f},B=function(a){return a.tile.removeClass(x).addClass("tiletype_"+a.type)},d=function(a){var b,c,d,e,f;switch(a.type){case w.grass:case w.plant:case w.tree:b=l(a.x,a.y,function(b){return b===a.type||b===w.water});break;default:return}switch(a.type){case w.grass:case w.plant:case w.tree:case w.water:if(b.length>=3){d=a.type;for(e=0,f=b.length;e<f;e++)c=b[e],o[0][c[0]][c[1]].type=w.none,B(o[0][c[0]][c[1]]);d=Math.min(w.tree,d+Math.floor(b.length/3)-1);switch(d){case w.tree:a.type=w.forest;break;case w.plant:a.type=w.tree;break;case w.grass:a.type=w.plant}return B(a)}}},a=function(a,b,c){var d,h,i;for(h=0,i=f.length;h<i;h++){d=f[h];if(d.x===a&&d.y===b)return!1}return f.push({x:a,y:b,type:c}),$("cloudid_"+f.length).show(),$(e({data:{id:f.length,type:c===g.acid?"acid":"water"}})).appendTo("#map")},m=function(){var a,b,c,d,e,h,i,j,k,l,m;c={};for(h=0,l=q-1;0<=l?h<=l:h>=l;0<=l?h++:h--)for(i=0,m=q-1;0<=m?i<=m:i>=m;0<=m?i++:i--)c[o[0][h][i].type]=c[o[0][h][i].type]||0,c[o[0][h][i].type]+=1;e=0;for(j=0,k=f.length;j<k;j++)a=f[j],a.alive&&a.type===g.water&&(e+=1);return b=0,b+=c[w.grass]||0,b+=c[w.plant]*2||0,b+=c[w.tree]*4||0,b+=c[w.forest]*8||0,d=c[w.water]+e*5,b>=100&&d>=50&&(y+=1,$(".locked"+y).removeClass("locked")),{plant:(b||0)+"/100",water:(d||0)+"/50"}},a=function(a,b,c){var d,h,i,j;for(i=0,j=f.length;i<j;i++){d=f[i];if(d.x===a&&d.y===b&&d.type===c)return!1}return h=f.length,f.push({x:a,y:b,type:c,id:h,alive:!0}),$(e({data:{id:h,x:a,y:b,type:c===g.acid?"acid":"water"}})).appendTo("#map")},z=function(){var a,b,c,d,e,g,h;h=[];for(e=0,g=f.length;e<g;e++){a=f[e];if(!a.alive){$(".cloudid_"+a.id).hide();continue}c=a.x,d=a.y,b=_([[c,d],[c+1,d],[c-1,d],[c,d+1],[c,d-1]]).chain().filter(function(a){return a[0]>=0&&a[0]<q}).filter(function(a){return a[1]>=0&&a[1]<q}).shuffle().value()[0],a.x=b[0],a.y=b[1],h.push($(".cloudid_"+a.id).css({top:a.x*50,left:a.y*50}))}return h},c=function(){var a,b,c,d,e,h,i,j;j=[];for(d=0,h=f.length;d<h;d++){a=f[d],c=o[0][a.x][a.y];for(e=0,i=f.length;e<i;e++)b=f[e],a.x===b.x&&a.y===b.y&&(a.type===g.water&&b.type===g.acid||a.type===g.water&&b.type===g.acid)&&(b.alive=!1,a.alive=!1);if(a.alive)switch(a.type){case g.water:switch(c.type){case w.none:c.type=w.water;break;case w.acid:c.type=w.water;break;case w.grass:c.type=w.plant;break;case w.plant:c.type=w.tree;break;case w.tree:c.type=w.forest}break;case g.acid:switch(c.type){case w.water:c.type=w.acid;break;case w.grass:c.type=w.none;break;case w.plant:c.type=w.grass;break;case w.tree:c.type=w.plant;break;case w.forest:c.type=w.tree}}j.push(B(c))}return j},A=function(){return $("#stats").html(t(m())),$("#storage").html(r(s))},$(function(){return $("#sky").hide(),p(),k(),j(),A(),$(".restart").live("click",function(){if($(this).hasClass("locked"))return;return $("#map").html(""),p($(this).data("robot")),j(),A()}),$(".res").live("click",function(){var a;a=$(this).data("robot");switch(a){case h.drill:case h.grass:u(a);break;case h.laser:s.laser>0&&u(a);break;case h.plant:s.plant>0&&u(a);break;case h.tree:s.tree>0&&u(a);break;case h.forest:s.forest>0&&u(a);break;case h.cloud:s.cloud>0&&u(a)}return!1}),$(".tile").live("click",function(){var e,f,i;f=$(this).data("robot"),i=o[0][f.x][f.y],e=!0;switch(b){case h.grass:switch(i.type){case w.none:i.type=w.grass;break;default:e=!1}break;case h.plant:switch(i.type){case w.none:i.type=w.plant;break;default:e=!1}break;case h.tree:switch(i.type){case w.none:i.type=w.tree;break;default:e=!1}break;case h.forest:switch(i.type){case w.none:i.type=w.forest;break;default:e=!1}break;case h.drill:switch(i.type){case w.trash:i.type=w.none,s.laser+=1;break;case w.grass:i.type=w.none;break;case w.plant:i.type=w.none,s.plant+=1;break;case w.tree:i.type=w.none,s.tree+=1;break;case w.forest:i.type=w.none,s.forest+=1;break;default:e=!1}break;case h.laser:switch(i.type){case w.ice:i.type=w.water,s.laser-=1;break;case w.water:i.type=w.none,s.laser-=1,s.cloud+=1;break;case w.none:i.type=w.none,s.laser-=1}break;case h.cloud:a(f.x,f.y,g.water)||(e=!1),s.cloud-=1;break;default:e=!1}if(e){B(i);for(;;)if(!d(i))break;c(),z(),k()}A()})})})).call(this);